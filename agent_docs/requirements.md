# 足場SaaSツール 要件定義 / 技術スタック概要（MVP）

## 1. 目的・概要

- 一般住宅向けくさび（ビケ）足場について、以下をブラウザ上で一気通貫で行う Web アプリ（将来 SaaS）を構築する。  
  - 建築図面（PDF / 画像 / DXF）からの条件抽出（外周・高さ・開口候補）  
  - 足場の自動割付＋手動・AI 修正  
  - 部材数量拾い（面別＋全体）  
  - 建物外周＋屋根形状および足場の簡易 3D ワイヤーフレーム表示
- AI エージェントと既存の Python 計算ロジックを組み合わせ、複雑形状の一般住宅でも実務で使える精度と操作性を目指す。

## 2. 対象・前提

- 対象建物  
  - 一般住宅（下屋・バルコニーあり）。  
  - 吊り足場・特殊支持・大規模建築は MVP 対象外。
- 外周形状  
  - X/Y 軸に平行な直線のみで構成された直角多角形を前提とする。  
  - 斜め（45° など）の壁・出隅は MVP では「直角近似」または「対象外」とするルールとする。
- 足場種別  
  - くさび（ビケ）足場。
- 図面形式  
  - PDF（平面・立面は別ファイルが基本）。  
  - 画像（JPEG / PNG）。  
  - DXF（Jw_cad はユーザー側で DXF 変換してアップロード）。
- 利用環境  
  - クライアント：ブラウザ（Mac を主対象、Windows も利用可）。  
  - サーバ：自社クラウド上の自前サーバ。図面・ログは外部 SaaS（公開 LLM API 等）に送信しない。

## 3. 数量仕様（MVP）

- 集計軸  
  - 部材種別。  
  - 規格・長さ。  
  - 面（南面・東面・西面・北面）。  
  - 建物全体合計。  
  - 将来：投げ縄で指定した任意範囲のみ集計。
- 部材種別  
  - 支柱  
  - 布材  
  - 手すり  
  - ブラケット  
  - 階段  
  - 先行手すり  
  - ハネ  
  - 筋交  
  - ジャッキ
- 規格・長さ  
  - 水平方向（内部単位 mm ／表示は m または mm）  
    - 1.8m, 1.5m, 1.2m, 0.9m, 0.6m, 0.355m, 0.3m, 0.15m  
  - 垂直方向（支柱寸法、すべて mm）  
    - 3800, 1900, 1230, 1095, 950, 910, 605, 475, 135
- 出力形式  
  - 画面右「数量」タブに表形式で表示。  
  - CSV / Excel 形式でダウンロード。  
  - 列イメージ：部材種別／規格長さ／面／数量／単位／備考。

## 4. 機能要件（MVP）

### F1: 案件管理・図面インポート

- 案件一覧画面で案件の新規作成・一覧・削除。  
- 案件ごとに以下のファイルを複数枚アップロード可能。  
  - 平面図 PDF / 画像 / DXF  
  - 立面図 PDF / 画像 / DXF（南／東等は別ファイル想定）
- 参照用図面ビューア  
  - インポートした建物図面（平面図・立面図）は、メインキャンバスとは別の参照用タブ/フローティングウィンドウとして開くことが可能。  
  - 表示/非表示の切り替え（閉じる）。  
  - ウィンドウのリサイズ（縮小・拡大）。  
  - ドラッグによる位置移動。  
  - メインキャンバスでの作業中に参照しながら作図できる。
- アップロード後、AI が図面を解析し、以下の初期案を生成。  
  - 建物外周ポリライン候補（直角多角形）  
  - 階数・階高・軒高など高さ条件の候補  
  - 平面図と立面図から建物のアイソメ図を自動生成（輪郭線ベースのワイヤーフレーム表現）  
  - 開口候補（玄関・窓などの開口位置、将来拡張）

### F2: スケール・外周・高さの確定

- スケール設定  
  - 寸法線上の 2 点をキャンバスでクリックし「実距離（mm）」を入力 → 図面スケール確定。
- 外周確定  
  - AI が検出した建物外周ポリライン候補をキャンバスにオーバーレイ表示。  
  - ユーザーは頂点（折れ点）の追加・削除・移動で外周を微修正。  
  - 全ての頂点は軸にスナップし、直角のみとなるよう補正。
- 高さ条件確定  
  - AI が階数・階高・軒高など高さ候補を提示。  
  - ユーザーが数値を確認・修正して確定。  
  - 外周線ごとに異なる高さ設定が可能（下屋・バルコニーなど）。AI 候補＋手動修正。

### F3: 足場条件・NG エリア設定

- 足場仕様テンプレ  
  - 標準スパン、階高ピッチ、控え条件などを含むテンプレートから選択。  
  - 案件ごとに数値上書き可能。
- NG エリア・開口指定  
  - キャンバス上で線分を引き、「ここからここまで幅 ○mm は開口（足場禁止）」を指定。  
  - 将来：投げ縄による任意範囲指定。
- チャット経由の条件修正（例）  
  - 「南面の足場をもう少し縮めて」  
  - 「スパンの間をもう少し広げて」  
  - 「ここは開口なので、スパンをずらして 1800 にしてほしい」  
  - 「高さをもう少し上げたい／下げたい」  
- AI は自然言語指示を解析し、対象面・対象スパン・高さの変更として内部パラメータに変換し、計算ロジックを再実行する。

### F4: 足場自動割付・手動修正・AI 修正

- 自動割付（既存 Python ロジックを利用）  
  - 入力：  
    - 建物外周ポリライン（直角多角形）  
    - 高さ条件（階数、階高、軒高、部分ごとの高さ）  
    - NG エリア・開口条件  
    - 足場仕様テンプレ  
  - 実装方針：  
    - 外周ポリラインから最大外接矩形（幅×奥行き）を算出。  
    - 各入隅・出隅を「外接矩形に対する削り／膨らませ長方形」として分解。  
    - 現在の Python ロジックが前提とする「大きな四角形＋任意数の入隅／出隅（直角）」モデルにマッピングして呼び出す。  
    - 必要に応じてロジックを拡張し、外周ポリラインを直接受け取るよう修正してもよい。
- 出力：  
  - 支柱・布材・手すり・ブラケット・階段・先行手すり・ハネ・筋交・ジャッキの配置情報（2D / 3D 座標・接続情報）。  
  - 数量集計用データ（部材種別×規格長さ×面ごとの本数）。
- 手動修正  
  - キャンバス上で支柱・スパンをドラッグ等により局所的に修正可能。  
  - 修正結果に応じて数量を再集計。
- AI 修正  
  - チャットからの自然言語指示をもとに、面単位または全体の条件を変更し再割付を行う。

### F5: 建物・足場の 3D / アイソメ / パース表示

- 建物アイソメ図の自動生成  
  - 入力：平面図外周ポリライン＋立面情報（高さ・屋根勾配等）。  
  - 処理：  
    - 外周ポリラインを壁として上方向に押し出し。  
    - 立面から屋根の最高高さ・勾配を推定し、屋根線を構成。  
    - 玄関・開口位置を線で表現。  
  - 出力：外枠＋屋根形状＋開口位置を線（ワイヤーフレーム）で表現したアイソメ図。  
  - 表現方針：リアルな建物（窓や模様など）は表現せず、建物の輪郭線と屋根形状、玄関など開口位置がわかる程度のシンプルな線画表現とする。  
  - アイソメ図は独立したビューとして可視化可能。
- 足場 3D 表示  
  - 支柱・布材・手すり・ブラケット・階段・先行手すり等を線（エッジ）として 3D 表示。  
  - 建物ワイヤーフレームと同一 3D 空間に重ねて描画。  
  - 表示例：建物はグレー系、足場は色分け（支柱・布・手すりなど）。
- パース表示（透視図法）  
  - 建物と足場を透視図法で表示し、より現実的な奥行き感で視覚確認が可能。  
  - ワイヤーフレーム表現を維持しつつ、遠近感のある表示を提供。
- 操作  
  - マウスドラッグで回転。  
  - ホイールでズーム。  
  - 右ドラッグで平行移動。  
  - 主用途は平面割付の妥当性を立体的にざっと確認すること。  
  - 将来：AR 表示やジェスチャー操作（WebXR 等）の拡張を検討。

### F6: 数量拾い・集計・出力

- 割付結果から、部材種別×規格長さ×面別＋全体の数量を自動集計。  
- 「数量」タブで一覧表示。  
- CSV / Excel 形式で出力（将来、実際の数量表フォーマットに合わせて列追加・名称調整）。  
- 将来：投げ縄で指定した任意範囲のみの数量集計機能を追加。

### F7: 平面図・図面出力

- 足場平面配置図をキャンバスに表示。  
- PDF / PNG として出力（図面ヘッダ・簡易タイトル等を付与可能）。  
- 将来：立面足場展開図の出力にも拡張できる構造とする。

### F8: AI 学習・自己改善（MVP 版）

- 各案件で「AI 初期案（外周・高さ・割付）」と「最終確定案」の差分を保存。  
- 類似条件（階数・外周形状・延べ床面積など）が近い過去案件を内部で参照し、次回の初期案精度を向上。  
- ユーザーは案件コピー等を意識する必要はなく、内部的に学習が進む。

### F9: チャット・指示パネル

- 右サイドにチャットタブを配置。  
- AI の解析結果や解釈した指示内容を、適用前にテキストで確認可能。  
- よく使う指示（スパン拡縮、高さ上下、開口指定など）は将来ボタン化を検討。

## 5. 画面構成（概要）

### 画面 A: 案件一覧

- 案件名／住所／作成日／更新日／ステータスを表示。  
- 「新規案件作成」「開く」「削除」のみを提供。  
- 案件コピー機能は MVP では不要。

### 画面 B: 足場計画画面（メイン）

- 中央：大キャンバス  
  - 表示タブ：  
    - 建物平面（背景図面＋足場オーバーレイ）  
    - 建物立面（将来、南／東等を切替）  
    - 足場平面（足場のみの配置図）  
    - 3D（建物＋足場のワイヤーフレーム）  
    - アイソメ（自動生成された建物アイソメ図＋足場、輪郭線ベース）  
    - パース（建物＋足場の透視図法表示）
- 参照用図面ビューア（フローティングパネル）  
  - インポートした建物平面図・立面図を別タブ/フローティングウィンドウとして表示。  
  - 表示/非表示トグル、縮小/拡大/移動が可能。  
  - メインキャンバスでの作業を邪魔しない位置に配置可能。  
  - 図面を見ながら足場作図作業を行える。
- 左：ツールパレット  
  - 選択／移動。  
  - 頂点編集（外周修正）。  
  - 開口線指定。  
  - 将来：投げ縄選択。
- 右：サイドパネル（タブ切替）  
  - 「建物・図面」タブ：スケール、階数、高さ条件、外周リスト。  
  - 「足場条件」タブ：スパン、階高ピッチ、控え条件、テンプレ選択。  
  - 「数量」タブ：数量表。  
  - 「チャット」タブ：AI との対話。  
  - 将来：「履歴」タブ：操作履歴・ロールバック。

## 6. 技術スタック / SDK 方針（MVP）

### 6.1 全体アーキテクチャ

- 構成  
  - フロントエンド：TypeScript + React ベース SPA。  
  - バックエンド API：Python（FastAPI）による REST / WebSocket API。  
  - AI サービス：自社クラウド内で動作する LLM / 画像解析サーバ（将来スケール可能な別プロセス）。  
  - データベース：PostgreSQL（案件・図面メタデータ・足場条件・ログ・学習データ）。  
  - ファイルストレージ：ローカルディスク or S3 互換オブジェクトストレージ（図面ファイル・生成図面）。

### 6.2 フロントエンド

- 言語・フレームワーク  
  - TypeScript  
  - React  
  - ビルドツール：Vite または Next.js（SPA としての Vite 優先、将来 SSR が必要なら Next.js 検討）
- UI / 状態管理  
  - UI：Tailwind CSS + シンプルな UI コンポーネントライブラリ（例：Headless UI）  
  - 状態管理：Zustand または Redux Toolkit（MVP では軽量な Zustand を優先）
- 2D キャンバス  
  - HTML5 Canvas ベース。  
  - ライブラリ候補：Konva.js + react-konva（図形編集・ドラッグ・スナップに強い）。  
  - 機能：外周ポリライン編集、支柱・スパン表示、開口線指定、投げ縄選択（将来）。
- 3D 表示  
  - Three.js をベースとした 3D 描画。  
  - React との連携：react-three-fiber（必要に応じて）＋ drei。  
  - 建物・足場ともにワイヤーフレーム（線）で表示。
- チャット UI  
  - 右サイドパネルにシンプルなチャットコンポーネントを実装。  
  - バックエンドの AI エージェント API と連携し、ストリーミング表示にも拡張可能な設計とする。

### 6.3 バックエンド（API / 計算ロジック）

- 言語・フレームワーク  
  - Python 3.11+  
  - FastAPI（REST + WebSocket、OpenAPI ドキュメント自動生成）
- 足場計算ロジック  
  - 既存 Python コードをモジュール化し、`calculate_scaffold(...)` のような関数としてラップ。  
  - 入力：外周ポリライン、出隅・入隅情報、高さ条件、足場仕様テンプレ、NG エリアなど。  
  - 出力：  
    - 足場部材ごとの配置情報（2D / 3D 座標・種類・長さ）。  
    - 数量集計用データ（部材種別×規格長さ×面）。
- 図面解析  
  - PDF → 画像変換：pdf2image / poppler 等。  
  - 画像解析：OpenCV ベースで線・輪郭・寸法線を抽出。  
  - DXF 解析：ezdxf 等で線分・レイヤ情報を取得。  
  - LLM / CV モデルに渡す前処理として使用。
- 永続化  
  - ORM：SQLAlchemy + Alembic（マイグレーション）。  
  - モデル：案件、図面ファイル、外周情報、高さ条件、足場結果、数量、AI ログ等。

### 6.4 AI / エージェント

- 役割  
  - 図面の理解：外周候補、階数・高さ候補、開口候補の推定。  
  - チャット指示の解釈：自然言語 → パラメータ変更。  
  - 過去案件の参照：類似案件を探し、初期案の精度を上げる。
- 実装方針  
  - 優先案：Anthropic Claude を利用し、`claude-agent-sdk-python` を用いたエージェント実装とする。  
    - Python 側で図面解析・足場計算等を「ツール」として定義し、Claude エージェントから呼び出す。  
    - 図面や条件は Anthropic API に送信されるため、情報取扱いポリシー上問題ない前提が必要。  
  - 将来案：完全オンプレミス運用が必須な場合は、自社クラウド内で動作する LLM（vLLM + オープンモデル等）＋独自エージェントフレームワークに差し替え可能な構成にする。  
  - 画像解析（図面）については、専用のビジョンモデル or ルールベース＋ LLM を組み合わせる。  
  - エージェントは「ツール呼び出し（Python ロジックの API 呼び出し）」を行う形で実装。

### 6.5 将来拡張（AR / ジェスチャー）

- 将来、建物＋足場のワイヤーフレーム 3D モデルを AR 表示し、  
  手のジェスチャーで回転・ズームなどを行うことを想定。  
- 技術方針（将来案）  
  - WebXR + Web カメラ + 手検出（MediaPipe 等）によるブラウザベースの AR。  
  - もしくは iOS / Android ネイティブアプリ（ARKit / ARCore）側で 3D モデルを読み込んで表示。  
- MVP では AR / ジェスチャーは対象外だが、3D データフォーマット（頂点・エッジ構造）を  
  他クライアントでも読み込みやすい形にしておく。

## 7. 非機能要件（MVP）

- データ保護  
  - 図面・案件データ・ログは自社クラウド内で完結。  
  - 公開クラウドの SaaS へ図面データを送信しない構成を前提とする。
- 性能  
  - 一般住宅規模で、足場再計算の応答時間は数秒〜十数秒を目標とする。  
  - キャンバス・3D 表示は実用的なフレームレート（30fps 目安）を維持。
- 信頼性  
  - AI 提案はあくまで補助であり、最終確認と責任はユーザーにある旨を UI 上に明示。  
  - 重要な操作（再割付、大きな条件変更）は確認ダイアログや履歴からのロールバックを検討。
- 拡張性  
  - 立面展開図の出力、レンダリング強化、モデル再学習等に対応できるよう、  
    足場・建物情報を構造化データとして管理する。
