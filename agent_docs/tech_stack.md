# 技術スタック設計（MVP 想定）

このドキュメントは、足場SaaSツールの MVP 開発で想定する技術スタックを整理したものです。  
要件定義の詳細は `requirements.md` を参照してください。

---

## 1. 全体アーキテクチャ

- クライアント：ブラウザ（Mac / Windows）  
- サーバサイド：自社クラウド上の Python / FastAPI ベース API サーバ  
- データベース：PostgreSQL  
- ファイルストレージ：ローカルディスク or S3 互換ストレージ  
- AI エージェント：Anthropic Claude（`claude-agent-sdk-python`）＋ 図面解析 / 足場ロジック用ツール群  
- 3D 表示：ブラウザ内 three.js ベースのワイヤーフレーム描画

---

## 2. フロントエンド

### 2.1 言語・基盤

- 言語：TypeScript  
- フレームワーク：Next.js（App Router）  
- ビルドツール：Next.js 組み込み  
  - SSR / SSG サポート  
  - ファイルベースルーティング  
  - API Routes（将来の BFF として利用可能）

### 2.2 UI / 状態管理

- スタイル / コンポーネント  
  - Tailwind CSS（ユーティリティクラス中心）  
  - Headless UI 等の軽量コンポーネントライブラリ（モーダル・タブ・ドロップダウンなど）
- 状態管理  
  - Zustand を採用（シンプルでローカルステート寄りの構成に向いている）。  
  - グローバルで持つもの：現在の案件、図面メタ情報、足場計算結果、AI チャット履歴など。

### 2.3 2D キャンバス

- 技術：HTML5 Canvas  
- ライブラリ候補：Konva.js + react-konva  
  - 図形（ライン・ポリライン・シンボル）の描画と編集  
  - ドラッグ＆ドロップ、選択、スナップ（直角・グリッド）  
  - 将来の投げ縄選択にも対応しやすい。

### 2.4 3D / アイソメ / パース表示

- 技術：Three.js  
- React 連携：react-three-fiber + @react-three/drei  
- 3D ワイヤーフレーム表示  
  - 建物外周＋屋根のワイヤーフレームモデル  
  - 足場（支柱・布材・手すり・ブラケット・階段・先行手すりなど）のワイヤーフレーム表示  
  - 操作：ドラッグ回転 / ホイールズーム / 平行移動
- アイソメ図表示  
  - 平面図外周＋立面情報から輪郭線ベースのアイソメ図を自動生成  
  - 表現方針：リアルな建物（窓・模様など）は表現せず、建物の輪郭線と屋根形状、玄関など開口位置がわかる程度のシンプルな線画表現  
  - Three.js の OrthographicCamera を使用した等角投影表示
- パース表示（透視図法）  
  - Three.js の PerspectiveCamera を使用した透視投影表示  
  - ワイヤーフレーム表現を維持しつつ、遠近感のある表示を提供

### 2.5 参照用図面ビューア（フローティングパネル）

- 目的：インポートした建物図面（平面図・立面図）をメインキャンバスとは別のフローティングウィンドウとして表示し、図面を見ながら作業可能にする。  
- 機能  
  - 表示/非表示の切り替え（閉じる）  
  - ウィンドウのリサイズ（縮小・拡大）  
  - ドラッグによる位置移動  
- 技術選定  
  - フローティングパネル：react-rnd（リサイズ＋ドラッグ対応）またはカスタム実装  
  - 図面表示：IMG タグ or Canvas（Konva）でパン・ズーム対応  
  - 状態管理：Zustand でパネルの表示状態・位置・サイズを管理

### 2.6 フロントエンドその他

- HTTP クライアント：fetch API ラッパ or axios  
- フォーム管理：React Hook Form（設定パネルなどのフォーム用）  
- アイコン：Heroicons 等

---

## 3. バックエンド（API / 計算）

### 3.1 言語・フレームワーク

- 言語：Python 3.11+  
- Web フレームワーク：FastAPI  
  - REST API と WebSocket（チャット / プログレス通知）を提供  
  - OpenAPI / Swagger UI による API ドキュメント自動生成

### 3.2 足場計算ロジック

- ベース：既存の足場割付 Python ロジックを利用  
  - 「最大外接矩形＋削り／膨らまし」のモデルに対応済み。  
  - 外周ポリラインからの変換レイヤーを新規実装して利用。  
- 構成イメージ  
  - `scaffold_logic` パッケージとしてロジックをモジュール化。  
  - `calculate_scaffold(...)` 関数を中心に、  
    - 入力：外周ポリライン、高さ条件、NG エリア、足場仕様テンプレなど  
    - 出力：部材配置情報（2D / 3D 座標）＋数量集計用データ  
  - FastAPI 経由でフロントから呼び出し。

### 3.3 図面解析

- PDF → 画像変換  
  - ライブラリ：pdf2image / poppler  
- 画像解析（PDF / 画像）  
  - OpenCV（エッジ検出、直線抽出、輪郭抽出、寸法線検出など）  
  - 必要に応じて画像ベースのビジョンモデルと組み合わせる。
- DXF 解析（Jw_cad 変換後）  
  - ライブラリ：ezdxf  
  - 線分・ポリライン・レイヤ情報を取得し、外周候補抽出の入力にする。

### 3.4 データベース・ストレージ

- DB：PostgreSQL  
  - ORM：SQLAlchemy  
  - マイグレーション：Alembic  
  - 管理対象：案件、図面ファイルメタ情報、外周・高さ条件、足場結果、数量表、AI ログ等。
- ファイルストレージ  
  - オプション 1：サーバローカルディスク（小規模運用）  
  - オプション 2：S3 互換ストレージ（将来のスケールを考慮）

---

## 4. AI エージェント層

### 4.1 ベース SDK

- ライブラリ：`claude-agent-sdk-python`  
  - Anthropic Claude を用いたエージェントを実装。  
  - Python 側でツール（図面解析・足場計算など）を定義し、Claude から呼び出す構成。

### 4.2 主なツール候補（案）

- `parse_drawing`  
  - 図面ファイル（PDF / 画像 / DXF）から外周候補・階数・高さ候補・開口候補を抽出。  
- `suggest_heights`  
  - 既存図面とユーザー入力を組み合わせて高さ条件を補完・提案。  
- `compute_scaffold`  
  - 足場計算ロジック（`calculate_scaffold`）を呼び出し、結果を返す。  
- `edit_scaffold`  
  - チャット指示に基づいてスパン・高さなどを変更し、再計算する。  
- `retrieve_similar_cases`  
  - 過去案件から類似条件の事例を検索し、初期案の改善に役立てる。

### 4.3 モデル運用上の前提

- 図面や条件が Anthropic API に送信されることを前提に、情報取り扱いポリシーを明確化する。  
- 将来的に完全オンプレミス運用が必要な場合は、  
  - LLM 部分を自社クラウド内のオープンモデル＋独自エージェント層へ差し替え可能な構成とする。

---

## 5. インフラ・運用

- インフラ  
  - 自社クラウド（VPS / IaaS）上に API サーバ＋DB＋ストレージを構成。  
  - 小規模開始：単一VM上に API + DB（バックアップ込み）、将来分離を想定。
- 認証・認可  
  - MVP 初期：単一ユーザー利用前提なら簡易認証でも可。  
  - SaaS 化を見据える場合：JWT ベースのユーザー管理を前提に設計。


